@using EL.Entities
@using EL.Enums
@model Vetify.Models.ViewModel.OdemelerViewModel

@{
    ViewData["Title"] = "Odemeler";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<main class="container-fluid px-4 py-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="page-title mb-2">Ödeme Yönetimi</h1>
            <p class="text-muted">Tüm ödemeleri görüntüleyin ve yönetin</p>
        </div>
        <div class="col-md-6 text-md-end">
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                <i class="bi bi-plus-circle me-2"></i>Yeni Ödeme Kaydet
            </button>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon bg-success-soft">
                    <i class="bi bi-cash-stack text-success"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">₺@Model.BuAyToplam.ToString("N2")</h3>
                    <p class="stat-label">Bu Ay Toplam</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon bg-primary-soft">
                    <i class="bi bi-wallet2 text-primary"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">₺@Model.BugunAlinan.ToString("N2")</h3>
                    <p class="stat-label">Bugün Alınan</p>
                    <span class="stat-change">@Model.BugunIslemSayisi işlem</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon bg-warning-soft">
                    <i class="bi bi-exclamation-circle text-warning"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">₺@Model.BekleyenBorc.ToString("N2")</h3>
                    <p class="stat-label">Bekleyen Borç</p>
                    <span class="stat-change">@Model.BorcluMusteriSayisi müşteri</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon bg-info-soft">
                    <i class="bi bi-graph-up text-info"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">₺@Model.YillikToplam.ToString("N2")</h3>
                    <p class="stat-label">Yıllık Toplam</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card custom-card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Hayvan, sahip veya randevu ara...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card custom-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Randevu</th>
                                    <th>Hayvan</th>
                                    <th>Sahip</th>
                                    <th>Ödeme Tarihi</th>
                                    <th>Tutar</th>
                                    <th>Ödeme Yöntemi</th>
                                    <th>Durum</th>
                                    <th style="width: 120px;">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var odeme in Model.Odemeler)
                                {
                                    var toplamTedavi = odeme.Randevu?.Tedaviler?.Sum(t => t.Ucret) ?? 0;
                                    var toplamOdeme = odeme.Randevu?.Odemeler?.Sum(o => o.Tutar) ?? 0;
                                    var kalanBorc = toplamTedavi - toplamOdeme;
                                    
                                    <tr>
                                        <td><span class="text-muted">#P@odeme.Id</span></td>
                                        <td>#@odeme.RandevuId</td>
                                        <td><strong>@odeme.Randevu?.Hayvan?.Ad</strong></td>
                                        <td>@odeme.Randevu?.Musteri?.AdSoyad</td>
                                        <td>@odeme.OdemeTarihi.ToString("D")</td>
                                        <td>
                                            @if (kalanBorc > 0)
                                            {
                                                <strong class="text-warning">₺@odeme.Tutar.ToString("N2")</strong><br />
                                                <small class="text-muted">Toplam: ₺@toplamTedavi.ToString("N2")</small>
                                            }
                                            else if (kalanBorc < 0)
                                            {
                                                <strong class="text-danger">₺@odeme.Tutar.ToString("N2")</strong>
                                            }
                                            else
                                            {
                                                <strong class="text-success">₺@odeme.Tutar.ToString("N2")</strong>
                                            }
                                        </td>
                                        <td>
                                            @switch (odeme.OdemeYontemi)
                                            {
                                                case OdemeYontemi.Nakit:
                                                    <span class="badge bg-light text-dark"><i class="bi bi-cash me-1"></i>Nakit</span>
                                                    break;
                                                case OdemeYontemi.KrediKarti:
                                                    <span class="badge bg-light text-dark"><i class="bi bi-credit-card me-1"></i>Kredi Kartı</span>
                                                    break;
                                                case OdemeYontemi.Havale:
                                                    <span class="badge bg-light text-dark"><i class="bi bi-bank me-1"></i>Havale</span>
                                                    break;
                                            }
                                        </td>
                                        <td>
                                            @if (kalanBorc <= 0)
                                            {
                                                <span class="badge bg-success">Ödendi</span>
                                            }
                                            else if (toplamOdeme > 0)
                                            {
                                                <span class="badge bg-warning">Kısmi Ödeme</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Ödenmedi</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary btn-view-payment"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#viewPaymentModal"
                                                        data-id="@odeme.Id"
                                                        data-randevu="#@odeme.RandevuId"
                                                        data-hayvan="@odeme.Randevu?.Hayvan?.Ad"
                                                        data-sahip="@odeme.Randevu?.Musteri?.AdSoyad"
                                                        data-tarih="@odeme.OdemeTarihi.ToString("D")"
                                                        data-tutar="₺@odeme.Tutar.ToString("N2")"
                                                        data-yontem="@odeme.OdemeYontemi"
                                                        data-notlar="@odeme.Notlar"
                                                        title="Detaylar">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                @if (kalanBorc > 0)
                                                {
                                                    <button class="btn btn-sm btn-outline-warning btn-add-payment"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#addPaymentModal"
                                                            data-randevu-id="@odeme.RandevuId"
                                                            data-kalan-borc="@kalanBorc"
                                                            title="Ödeme Al">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </button>
                                                }
                                                <a href="~/Vet/OdemeSil/@odeme.Id" class="btn btn-sm btn-outline-danger" 
                                                   onclick="return confirm('Bu ödemeyi silmek istediğinize emin misiniz?')" 
                                                   title="Sil">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="viewPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ödeme Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="mb-1">Randevu Bilgileri</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Randevu</small>
                            <span id="viewRandevu" class="fw-semibold">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Hayvan</small>
                            <span id="viewHayvan" class="fw-semibold">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Sahip</small>
                            <span id="viewSahip" class="fw-semibold">-</span>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="mb-3">
                    <h6 class="mb-1">Ödeme Bilgileri</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Tarih</small>
                            <span id="viewTarih">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Tutar</small>
                            <span id="viewTutar" class="text-success fw-semibold">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Yöntem</small>
                            <span id="viewYontem">-</span>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6 class="mb-1">Notlar</h6>
                    <p id="viewNotlar" class="mb-0 text-muted">-</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Ödeme Kaydet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentForm" asp-action="OdemeKaydet" asp-controller="Vet" method="post">
                    <div class="mb-3">
                        <label for="appointmentSelect" class="form-label">Randevu Seçin <span class="text-danger">*</span></label>
                        <select class="form-select" name="RandevuId" asp-items="ViewBag.randevular" id="appointmentSelect" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Ödeme Tutarı (₺) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-lg" name="Tutar" id="paymentAmount" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Ödeme Yöntemi <span class="text-danger">*</span></label>
                        <select class="form-select" name="OdemeYontemi" id="paymentMethod" required>
                            <option value="">Seçiniz...</option>
                            <option value="0">Nakit</option>
                            <option value="1">Kredi Kartı</option>
                            <option value="2">Havale/EFT</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">Ödeme Tarihi <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="OdemeTarihi" id="paymentDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNotes" class="form-label">Notlar</label>
                        <textarea class="form-control" name="Notlar" id="paymentNotes" rows="3" placeholder="Ödeme ile ilgili notlar..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Ödemeyi Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // View payment modal
        const viewButtons = document.querySelectorAll('.btn-view-payment');
        viewButtons.forEach(button => {
            button.addEventListener('click', function () {
                document.getElementById('viewRandevu').textContent = this.dataset.randevu;
                document.getElementById('viewHayvan').textContent = this.dataset.hayvan;
                document.getElementById('viewSahip').textContent = this.dataset.sahip;
                document.getElementById('viewTarih').textContent = this.dataset.tarih;
                document.getElementById('viewTutar').textContent = this.dataset.tutar;
                document.getElementById('viewYontem').textContent = this.dataset.yontem;
                document.getElementById('viewNotlar').textContent = this.dataset.notlar || '-';
            });
        });

        // Add payment button - pre-select randevu
        const addPaymentButtons = document.querySelectorAll('.btn-add-payment');
        addPaymentButtons.forEach(button => {
            button.addEventListener('click', function () {
                const randevuId = this.dataset.randevuId;
                const appointmentSelect = document.getElementById('appointmentSelect');
                if (appointmentSelect && randevuId) {
                    appointmentSelect.value = randevuId;
                }
            });
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function () {
                const filter = this.value.toLowerCase();
                const rows = document.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            });
        }

        // Set today's date as default
        const paymentDate = document.getElementById('paymentDate');
        if (paymentDate) {
            paymentDate.valueAsDate = new Date();
        }
    });
</script>
